<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FinPulse Waterfall Pro - 財務瀑布拆解工具</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 載入 Babel 用於瀏覽器解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 載入 Lucide 圖標 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 載入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: contain;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        .drag-transition {
            transition: transform 0.2s ease, opacity 0.2s ease, padding 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* 防止 iOS 長按選取 */
        .grabbing, .grabbing * {
            user-select: none !important;
            -webkit-user-select: none !important;
            -webkit-touch-callout: none !important;
        }
        .touch-handle {
            touch-action: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const DEMO_FINANCIAL_STEPS = [
            { id: 1, label: '營業收入', enLabel: 'Revenue', value: 2500000, type: 'total' },
            { id: 2, label: '營業成本', enLabel: 'COGS', value: 800000, type: 'subtract' },
            { id: 3, label: '毛利', enLabel: 'Gross Profit', value: 0, type: 'subtotal' },
            { id: 4, label: '營業費用', enLabel: 'OPEX', value: 300000, type: 'subtract' },
            { id: 5, label: 'EBITDA', enLabel: 'EBITDA', value: 0, type: 'subtotal' },
            { id: 6, label: '折舊', enLabel: 'Depreciation', value: 100000, type: 'subtract' },
            { id: 7, label: '攤銷', enLabel: 'Amortization', value: 20000, type: 'subtract' },
            { id: 8, label: '營業利益', enLabel: 'EBIT', value: 0, type: 'subtotal' },
            { id: 9, label: '業外收入', enLabel: 'Non-op Income', value: 50000, type: 'add' },
            { id: 10, label: '業外支出', enLabel: 'Non-op Expense', value: 20000, type: 'subtract' },
            { id: 11, label: '利息支出', enLabel: 'Interest Expense', value: 10000, type: 'subtract' },
            { id: 12, label: '營利事業所得稅', enLabel: 'ROC Taxes', value: 0, type: 'tax_roc' }, 
            { id: 13, label: '淨利', enLabel: 'Net Income', value: 0, type: 'subtotal' },
        ];

        const EMPTY_INITIAL_STEPS = DEMO_FINANCIAL_STEPS.map(step => ({
            ...step,
            value: step.type === 'total' || step.type === 'subtract' || step.type === 'add' ? "" : 0
        }));

        const formatWithCommas = (val) => {
            if (val === "" || val === undefined || val === null) return "";
            const num = parseFloat(String(val).replace(/,/g, ''));
            if (isNaN(num)) return "";
            return num.toLocaleString();
        };

        const App = () => {
            const [isDark, setIsDark] = useState(true);
            const [showGrid, setShowGrid] = useState(true); 
            const [steps, setSteps] = useState(EMPTY_INITIAL_STEPS);
            const [chartTitle, setChartTitle] = useState('價值鏈分析');
            const [draggedIdx, setDraggedIdx] = useState(null);
            const [dragOverIdx, setDragOverIdx] = useState(null);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            const negativeStripePattern = useMemo(() => {
                const canvas = document.createElement('canvas');
                canvas.width = 8; canvas.height = 8;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#7f1d1d'; ctx.fillRect(0, 0, 8, 8);
                ctx.strokeStyle = '#f43f5e'; ctx.lineWidth = 1.5;
                ctx.beginPath(); ctx.moveTo(0, 8); ctx.lineTo(8, 0); ctx.stroke();
                return ctx.createPattern(canvas, 'repeat');
            }, []);

            useEffect(() => {
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                if (window.lucide) window.lucide.createIcons();
            }, [isDark, steps]);

            const calculateROCTax = (p) => {
                if (p <= 120000) return 0;
                if (p <= 200000) return Math.round((p - 120000) * 0.5);
                return Math.round(p * 0.2);
            };

            const calculatedData = useMemo(() => {
                let currentRunningTotal = 0;
                return steps.map((step) => {
                    let start = 0, end = 0;
                    const numericValue = (step.value === "" || step.value === "-") ? 0 : Number(step.value);
                    let displayValue = numericValue;

                    if (step.type === 'total') {
                        start = 0; end = numericValue; currentRunningTotal = numericValue;
                    } else if (step.type === 'subtotal') {
                        start = 0; end = currentRunningTotal; displayValue = currentRunningTotal;
                    } else if (step.type === 'subtract') {
                        start = currentRunningTotal; currentRunningTotal -= numericValue; end = currentRunningTotal;
                    } else if (step.type === 'add') {
                        start = currentRunningTotal; currentRunningTotal += numericValue; end = currentRunningTotal;
                    } else if (step.type === 'tax_roc') {
                        const tax = calculateROCTax(currentRunningTotal);
                        start = currentRunningTotal; currentRunningTotal -= tax; end = currentRunningTotal; displayValue = tax;
                    }
                    return { ...step, start, end, calcValue: displayValue };
                });
            }, [steps]);

            useEffect(() => {
                if (!chartRef.current) return;
                const ctx = chartRef.current.getContext('2d');
                if (chartInstance.current) chartInstance.current.destroy();
                chartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: calculatedData.map(d => Array.from(d.label)),
                        datasets: [{
                            data: calculatedData.map(d => [d.start, d.end]),
                            backgroundColor: calculatedData.map(d => {
                                const isIncomeType = d.type === 'total' || d.type === 'subtotal' || d.type === 'add';
                                if (isIncomeType) {
                                    return d.calcValue < 0 ? negativeStripePattern : (isDark ? '#3b82f6' : '#2563eb');
                                }
                                return '#f43f5e';
                            }),
                            borderColor: calculatedData.map(d => {
                                if (d.calcValue < 0 && (d.type === 'total' || d.type === 'subtotal')) return '#fb7185';
                                return 'transparent';
                            }),
                            borderWidth: 1, borderRadius: 2, borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: (items) => {
                                        const itm = calculatedData[items[0].dataIndex];
                                        return `${itm.label} (${itm.enLabel})`;
                                    },
                                    label: (ctx) => {
                                        const d = calculatedData[ctx.dataIndex];
                                        return ` 數值: $${d.calcValue.toLocaleString()} (餘額: $${Math.max(d.start, d.end).toLocaleString()})`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { color: isDark ? '#94a3b8' : '#64748b', font: { size: 10, weight: '700' } }, grid: { display: false } },
                            y: { 
                                grid: { 
                                    color: (context) => {
                                        if (context.tick && context.tick.value === 0) {
                                            return isDark ? 'rgba(255, 255, 255, 0.6)' : 'rgba(0, 0, 0, 0.4)';
                                        }
                                        if (!showGrid) return 'transparent';
                                        return isDark ? 'rgba(255, 255, 255, 0.15)' : '#f1f5f9';
                                    },
                                    lineWidth: (context) => (context.tick && context.tick.value === 0 ? 2 : 1)
                                },
                                ticks: { color: isDark ? '#94a3b8' : '#64748b', font: { size: 10 }, callback: (v) => `$${v.toLocaleString()}` }
                            }
                        }
                    }
                });
            }, [calculatedData, isDark, showGrid]);

            const revenue = calculatedData[0]?.calcValue || 0;
            const safeRev = Math.max(1, revenue);
            const grossProfit = calculatedData.find(d => d.label === '毛利')?.calcValue || 0;
            const operatingProfit = calculatedData.find(d => d.label === '營業利益')?.calcValue || 0;
            const tax = calculatedData.find(d => d.type === 'tax_roc')?.calcValue || 0;
            const preTax = calculatedData.find(d => d.type === 'tax_roc')?.start || 0;
            const netIncome = calculatedData[calculatedData.length - 1]?.calcValue || 0;
            const expenseSum = steps.filter(s => s.type === 'subtract').reduce((acc, curr) => acc + (curr.value === "" ? 0 : Number(curr.value)), 0);

            const downloadChart = () => {
                const originalCanvas = chartRef.current;
                const scale = 2; 
                const w = originalCanvas.clientWidth * scale;
                const h = originalCanvas.clientHeight * scale;
                const tempCanvas = document.createElement('canvas');
                const tCtx = tempCanvas.getContext('2d');
                const headerHeight = 120 * scale;
                const padding = 30 * scale;
                tempCanvas.width = w + (padding * 2);
                tempCanvas.height = h + headerHeight + (padding * 2);
                tCtx.fillStyle = isDark ? '#0f172a' : '#ffffff';
                tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                tCtx.fillStyle = isDark ? '#ffffff' : '#1e293b';
                tCtx.font = `900 ${Math.round(24 * scale)}px "Noto Sans TC"`;
                tCtx.textBaseline = 'top';
                tCtx.fillText(chartTitle, padding, padding);
                tCtx.textAlign = 'right';
                tCtx.fillStyle = isDark ? '#94a3b8' : '#64748b';
                tCtx.font = `bold ${Math.round(10 * scale)}px "Noto Sans TC"`;
                tCtx.fillText('最終預估淨利', tempCanvas.width - padding, padding);
                tCtx.fillStyle = netIncome >= 0 ? '#2563eb' : '#e11d48';
                tCtx.font = `900 ${Math.round(48 * scale)}px "Noto Sans TC"`;
                tCtx.fillText(`$${Math.round(netIncome).toLocaleString()}`, tempCanvas.width - padding, padding + (18 * scale));
                tCtx.drawImage(originalCanvas, padding, headerHeight + padding, w, h);
                const now = new Date();
                const yyyymmdd = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
                const url = tempCanvas.toDataURL('image/png', 1.0);
                const link = document.createElement('a');
                link.download = `${yyyymmdd}_${chartTitle}.png`;
                link.href = url;
                link.click();
            };

            const handleInputChange = (id, rawValue) => {
                const cleanValue = rawValue.replace(/,/g, '');
                if (cleanValue === "" || cleanValue === "-") {
                    setSteps(steps.map(s => s.id === id ? { ...s, value: cleanValue } : s));
                    return;
                }
                const num = parseFloat(cleanValue);
                if (!isNaN(num)) setSteps(steps.map(s => s.id === id ? { ...s, value: num } : s));
            };

            const handleLabelChange = (id, label) => setSteps(steps.map(s => s.id === id ? { ...s, label } : s));
            const handleEnLabelChange = (id, enLabel) => setSteps(steps.map(s => s.id === id ? { ...s, enLabel } : s));
            const addStep = (type) => setSteps([...steps, { id: Date.now(), label: type === 'subtract' ? '新支出' : type === 'add' ? '新收入' : '新結算', enLabel: 'NEW ITEM', value: type === 'subtotal' ? 0 : "", type }]);
            const removeStep = (id) => steps.length > 1 && setSteps(steps.filter(s => s.id !== id));

            const reorderSteps = (fromIndex, toIndex) => {
                if (fromIndex === toIndex) return;
                const newSteps = [...steps];
                const [removed] = newSteps.splice(fromIndex, 1);
                newSteps.splice(toIndex, 0, removed);
                setSteps(newSteps);
            };

            const onTouchStart = (e, index) => {
                setDraggedIdx(index);
                document.body.classList.add('grabbing');
            };

            const onTouchMove = (e) => {
                if (draggedIdx === null) return;
                if (e.cancelable) e.preventDefault();
                const touch = e.touches[0];
                const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
                const stepEl = targetEl?.closest('[data-idx]');
                if (stepEl) {
                    const targetIdx = parseInt(stepEl.getAttribute('data-idx'));
                    if (targetIdx !== dragOverIdx) setDragOverIdx(targetIdx);
                }
            };

            const onTouchEnd = () => {
                if (draggedIdx !== null && dragOverIdx !== null) reorderSteps(draggedIdx, dragOverIdx);
                setDraggedIdx(null);
                setDragOverIdx(null);
                document.body.classList.remove('grabbing');
            };

            const onDragStart = (e, index) => { setDraggedIdx(index); e.dataTransfer.effectAllowed = "move"; };
            const onDragEnd = () => { setDraggedIdx(null); setDragOverIdx(null); };
            const onDragOver = (e, index) => { e.preventDefault(); if (dragOverIdx !== index) setDragOverIdx(index); };
            const onDrop = (e, index) => { e.preventDefault(); reorderSteps(draggedIdx, index); onDragEnd(); };

            return (
                <div className={`min-h-screen transition-colors duration-300 flex flex-col ${isDark ? 'bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
                    <header className={`h-16 border-b flex items-center justify-between px-4 sm:px-8 sticky top-0 z-50 backdrop-blur-md ${isDark ? 'bg-slate-900/80 border-slate-800' : 'bg-white/80 border-slate-200'}`}>
                        <div className="flex items-center gap-2 sm:gap-3">
                            <div className="bg-blue-600 p-1.5 sm:p-2 rounded-lg shadow-lg"><i data-lucide="layout-dashboard" className="text-white w-4 h-4 sm:w-5 sm:h-5"></i></div>
                            <h1 className={`font-extrabold text-base sm:text-xl tracking-tight italic underline decoration-blue-500/30 underline-offset-4 ${isDark ? 'text-white' : 'text-slate-900'}`}>FinPulse <span className="text-blue-500 font-black">Waterfall Pro</span></h1>
                        </div>
                        <button onClick={() => setIsDark(!isDark)} className={`p-2 rounded-xl border transition-all ${isDark ? 'bg-slate-800 border-slate-700 text-yellow-500' : 'bg-white border-slate-200 shadow-sm text-slate-600'}`}>
                            {isDark ? <i data-lucide="sun" className="w-4 h-4 sm:w-5 sm:h-5"></i> : <i data-lucide="moon" className="w-4 h-4 sm:w-5 sm:h-5"></i>}
                        </button>
                    </header>

                    <main className="max-w-[1650px] mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 flex-grow w-full">
                        {/* 左側編輯面板 */}
                        <div className="lg:col-span-4 space-y-4">
                            <div className={`rounded-2xl border p-4 sm:p-6 shadow-sm ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <div className="mb-4 sm:mb-6 flex justify-between items-start">
                                    <div><h2 className={`font-bold text-lg ${isDark ? 'text-white' : 'text-slate-900'}`}>價值鏈編輯</h2><p className="text-[10px] uppercase font-black opacity-50 tracking-widest">Data Control Center</p></div>
                                    <div className="flex gap-1.5">
                                        <button onClick={() => setSteps(EMPTY_INITIAL_STEPS)} className="p-2 hover:bg-rose-100 dark:hover:bg-rose-900/20 text-rose-500 border border-transparent hover:border-rose-200 rounded-lg transition-all" title="重置為零"><i data-lucide="eraser" className="w-4 h-4"></i></button>
                                        <button onClick={() => setSteps(DEMO_FINANCIAL_STEPS)} className="p-2 hover:bg-blue-100 dark:hover:bg-blue-900/20 text-blue-500 border border-transparent hover:border-blue-200 rounded-lg transition-all" title="載入範例數據"><i data-lucide="download" className="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                
                                <div className="space-y-2 max-h-[400px] lg:max-h-[500px] overflow-y-auto pr-2 custom-scrollbar relative" onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
                                    {steps.map((step, idx) => {
                                        const isIncomeType = step.type === 'total' || step.type === 'add';
                                        const isSubtractType = step.type === 'subtract';
                                        const isSettlement = !isIncomeType && !isSubtractType;
                                        const calcItem = calculatedData[idx];
                                        let bgColorClass = isIncomeType ? 'bg-[#DEEBF7] border-blue-200 dark:bg-blue-900/20 dark:border-blue-800/50' : isSubtractType ? 'bg-[#F9B9AF] border-rose-200 dark:bg-rose-900/20 dark:border-rose-800/50' : 'bg-slate-600 border-slate-500 dark:bg-slate-800 dark:border-slate-600';
                                        let textColorClass = isDark ? 'text-white' : (isSettlement ? 'text-white' : 'text-slate-900');
                                        let iconColorClass = isDark ? 'text-white/60' : (isSettlement ? 'text-white/60' : 'text-slate-400');
                                        
                                        return (
                                            <div key={step.id} data-idx={idx} draggable onDragStart={(e) => onDragStart(e, idx)} onDragEnd={onDragEnd} onDragOver={(e) => onDragOver(e, idx)} onDrop={(e) => onDrop(e, idx)} 
                                                 className={`p-2.5 sm:p-3 rounded-xl border flex items-center gap-2 sm:gap-3 drag-transition relative ${dragOverIdx === idx ? 'pt-8 border-t-2 border-t-blue-500' : ''} ${draggedIdx === idx ? 'opacity-40 scale-[0.98]' : ''} ${bgColorClass} ${textColorClass}`}>
                                                {dragOverIdx === idx && <div className="absolute top-2 left-0 right-0 flex justify-center items-center pointer-events-none"><div className="h-0.5 bg-blue-500 w-full mx-4 rounded-full opacity-50 animate-pulse"></div></div>}
                                                <div className={`touch-handle cursor-grab active:cursor-grabbing p-1.5 sm:p-2 rounded-lg shrink-0 shadow-sm border border-transparent transition-all ${isDark ? 'bg-slate-700/50 text-white/70' : (isSettlement ? 'bg-white/10 text-white' : 'bg-black/5 text-slate-500')}`} onTouchStart={(e) => onTouchStart(e, idx)}><i data-lucide="grip-vertical" className="w-4 h-4 sm:w-5 sm:h-5"></i></div>
                                                <div className="flex-grow flex flex-col gap-0.5 sm:gap-1 overflow-hidden">
                                                    <div className="flex items-center gap-2 overflow-hidden">
                                                        <input type="text" value={step.label} onChange={(e) => handleLabelChange(step.id, e.target.value)} className="bg-transparent font-bold text-[12px] sm:text-[13px] outline-none border-b border-transparent focus:border-current/30 w-full text-inherit truncate" />
                                                        <input type="text" value={step.enLabel} onChange={(e) => handleEnLabelChange(step.id, e.target.value)} className="bg-transparent text-[8px] sm:text-[9px] font-black uppercase outline-none border-b border-transparent focus:border-current/30 text-right shrink-0 w-16 sm:w-24 text-inherit opacity-70 truncate" />
                                                    </div>
                                                    {step.type !== 'subtotal' && step.type !== 'tax_roc' ? (
                                                        <div className="flex items-center gap-1 pl-4 text-xs sm:text-sm font-black">$<input type="text" value={formatWithCommas(step.value)} onChange={(e) => handleInputChange(step.id, e.target.value)} className="bg-transparent w-full outline-none border-b border-transparent focus:border-current/30 placeholder-current/40 font-black text-inherit" placeholder="0" /></div>
                                                    ) : (
                                                        <div className="text-[10px] sm:text-[11px] pl-4 font-black flex items-center gap-1 sm:gap-2"><span className="opacity-100">$ {calcItem.calcValue.toLocaleString()}</span><span className="hidden sm:inline text-[8px] opacity-60 italic font-medium uppercase tracking-tighter">{step.type === 'tax_roc' ? '(自動計算)' : '(自動結算)'}</span></div>
                                                    )}
                                                </div>
                                                <button onClick={() => removeStep(step.id)} className={`${iconColorClass} hover:text-rose-500 transition-colors p-1`}><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                                            </div>
                                        );
                                    })}
                                </div>

                                <div className="grid grid-cols-3 gap-2 mt-4 sm:mt-6">
                                    <button onClick={() => addStep('subtract')} className="py-2 rounded-lg border border-dashed border-rose-300 text-[10px] font-bold text-rose-600 hover:bg-rose-50 flex flex-col items-center gap-1 transition-all active:scale-95"><i data-lucide="minus-circle" className="w-4 h-4"></i> 支出</button>
                                    <button onClick={() => addStep('add')} className="py-2 rounded-lg border border-dashed border-blue-300 text-[10px] font-bold text-blue-600 hover:bg-blue-50 flex flex-col items-center gap-1 transition-all active:scale-95"><i data-lucide="plus-circle" className="w-4 h-4"></i> 收入</button>
                                    <button onClick={() => addStep('subtotal')} className="py-2 rounded-lg border border-dashed border-slate-300 text-[10px] font-bold text-slate-500 hover:bg-slate-50 flex flex-col items-center gap-1 transition-all active:scale-95"><i data-lucide="arrow-down-circle" className="w-4 h-4"></i> 結算</button>
                                </div>
                            </div>
                            
                            {/* 修正：營所稅說明區塊，確保在所有裝置上清晰可見 */}
                            <div className={`rounded-2xl border p-5 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <div className="flex items-center gap-2 mb-3 text-slate-500 font-black text-xs uppercase"><i data-lucide="calculator" className="w-4 h-4"></i> 財政部營所稅規則</div>
                                <div className="space-y-1.5 text-[10px] leading-relaxed text-slate-500 dark:text-slate-400 font-medium">
                                    <p>• 所得額 P ≤ 12 萬：<strong>免徵</strong></p>
                                    <p>• 12 萬 {"<"} P ≤ 20 萬：<strong>(P - 12 萬) × 1/2</strong></p>
                                    <p>• 所得額 P {">"} 20 萬：<strong>全額 20%</strong></p>
                                </div>
                            </div>
                        </div>

                        {/* 右側展示區 */}
                        <div className="lg:col-span-8 space-y-6">
                            <div className={`rounded-2xl border p-4 sm:p-8 shadow-xl min-h-[500px] lg:min-h-[850px] flex flex-col ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <div className="mb-4 sm:mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                    <div className="flex-grow w-full sm:max-w-[60%]">
                                        <input type="text" value={chartTitle} onChange={(e) => setChartTitle(e.target.value)} className={`text-xl sm:text-2xl font-black tracking-tight uppercase bg-transparent outline-none border-b border-transparent focus:border-blue-500 w-full ${isDark ? 'text-white' : 'text-slate-800'}`} placeholder="請輸入分析標題..." />
                                    </div>
                                    <div className="text-left sm:text-right w-full sm:w-auto">
                                        <p className="text-[10px] font-bold opacity-50 uppercase tracking-widest">最終預估淨利</p>
                                        <p className={`text-3xl sm:text-5xl font-black ${netIncome >= 0 ? 'text-blue-600' : 'text-rose-600'}`}>${Math.round(netIncome).toLocaleString()}</p>
                                    </div>
                                </div>
                                
                                <div className="flex-grow flex flex-col min-h-[350px] lg:min-h-[450px]">
                                    <div className="flex-grow relative h-[400px] lg:h-full"><canvas ref={chartRef}></canvas></div>
                                    
                                    <div className="flex justify-between items-center mt-6 sm:mt-4 px-1">
                                        <div className="flex items-center gap-2">
                                            <span className="text-[10px] font-black uppercase opacity-40">Grid</span>
                                            <button onClick={() => setShowGrid(!showGrid)} className={`relative w-10 h-5 rounded-full transition-colors duration-300 focus:outline-none ${showGrid ? 'bg-blue-600' : 'bg-slate-400 dark:bg-slate-700'}`}>
                                                <div className={`absolute top-1 left-1 bg-white w-3 h-3 rounded-full shadow-md transition-transform duration-300 ${showGrid ? 'translate-x-5' : ''}`}></div>
                                            </button>
                                            <span className={`text-[10px] font-black uppercase ${showGrid ? 'text-blue-500' : 'opacity-40'}`}>{showGrid ? 'On' : 'Off'}</span>
                                        </div>

                                        <button onClick={downloadChart} className="group flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 sm:px-5 py-2 sm:py-2.5 rounded-2xl text-[10px] sm:text-xs font-black shadow-xl shadow-blue-600/20 transition-all active:scale-95">
                                            <i data-lucide="download-cloud" className="w-4 h-4"></i>
                                            下載圖片
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="mt-6 sm:mt-8 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4">
                                    {[
                                        { label: '毛利率', val: `${((grossProfit / safeRev) * 100).toFixed(1)}%`, color: grossProfit >= 0 ? 'text-blue-600' : 'text-rose-600' },
                                        { label: '費用率', val: `${((expenseSum / safeRev) * 100).toFixed(1)}%`, color: 'text-rose-600' },
                                        { label: '營益率', val: `${((operatingProfit / safeRev) * 100).toFixed(1)}%`, color: operatingProfit >= 0 ? 'text-indigo-600' : 'text-rose-600' },
                                        { label: '實質稅率', val: `${((tax / Math.max(1, preTax)) * 100).toFixed(1)}%`, color: 'text-amber-600' },
                                        { label: '淨利率', val: `${((netIncome / safeRev) * 100).toFixed(1)}%`, color: netIncome >= 0 ? 'text-emerald-600' : 'text-rose-600' }
                                    ].map((kpi, i) => (
                                        <div key={i} className={`p-3 sm:p-4 rounded-xl border transition-all ${isDark ? 'bg-slate-800/50 border-slate-700' : 'bg-slate-50 border-slate-100 shadow-sm'}`}>
                                            <p className="text-[8px] sm:text-[9px] font-bold opacity-50 uppercase mb-1">{kpi.label}</p>
                                            <p className={`text-sm sm:text-lg font-black ${kpi.color}`}>{kpi.val}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>

                    <footer className={`py-6 sm:py-8 border-t mt-auto transition-colors duration-300 ${isDark ? 'bg-slate-900/50 border-slate-800 text-slate-400' : 'bg-white border-slate-200 text-slate-500'}`}>
                        <div className="max-w-[1650px] mx-auto px-4 sm:px-8 flex flex-col md:flex-row justify-between items-center gap-6 text-center md:text-left">
                            <div className="flex flex-col md:flex-row items-center gap-4 md:gap-8">
                                <a href="https://github.com/kasimchang" target="_blank" className="group flex items-center gap-3">
                                    <div className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full group-hover:bg-blue-500 group-hover:text-white transition-all"><i data-lucide="github" className="w-4 h-4"></i></div>
                                    <div className="flex flex-col">
                                        <span className="text-[10px] uppercase font-black tracking-widest opacity-60">Created by</span>
                                        <span className="text-sm font-bold tracking-tight">kasimchang</span>
                                    </div>
                                </a>
                                <div className="hidden md:block h-8 w-px bg-slate-200 dark:bg-slate-800"></div>
                                <div className="flex flex-col">
                                    <span className="text-[10px] uppercase font-black tracking-widest opacity-60">Copyright</span>
                                    <span className="text-sm font-bold tracking-tight italic">© 2026 FinPulse Waterfall Pro</span>
                                </div>
                            </div>
                            <div className="flex flex-col md:items-end">
                                <span className="text-[10px] uppercase font-black tracking-[0.3em] text-blue-500/80 mb-1">Precision Finance</span>
                                <p className="text-[11px] font-medium opacity-60">專為複雜財務結構設計的層級拆解引擎</p>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 500);
    </script>
</body>
</html>